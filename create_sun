import bpy
import math
import mathutils

# --- 1. ПАРАМЕТРЫ СОЛНЦА И ТЕНЕЙ ---
sun_energy = 6.0         # Яркость солнца
sun_softness = 2.0       # МЯГКОСТЬ (0.5 - резкие тени, 5.0 - очень мягкие)
shadow_resolution = 1024 # ЧЕТКОСТЬ (512, 1024 или 2048 - чем выше, тем больше ест памяти)
shadow_depth = 0.8       # КОНТАКТНЫЕ ТЕНИ (глубина проработки стыков и углов)

# --- 2. УДАЛЕНИЕ СТАРЫХ ОБЪЕКТОВ ---
for obj in bpy.data.objects:
    if (obj.type == 'LIGHT' and obj.data.type == 'SUN') or (obj.name == "Sun_Target"):
        bpy.data.objects.remove(obj, do_unlink=True)

# --- 3. СОЗДАНИЕ И НАСТРОЙКА СОЛНЦА ---
light_data = bpy.data.lights.new(name="Main_Sun", type='SUN')
light_data.energy = sun_energy
light_data.color = (1.0, 0.98, 0.9) # Чуть теплый свет

# Настройка мягкости через угол (Size/Angle)
light_data.angle = math.radians(sun_softness)

# Настройка контактных теней (чтобы здание не "летало")
light_data.use_contact_shadow = True
light_data.contact_shadow_distance = shadow_depth
light_data.shadow_soft_size = 1.0 # Внутренняя мягкость карты теней

sun_obj = bpy.data.objects.new(name="Main_Sun", object_data=light_data)
bpy.context.collection.objects.link(sun_obj)

# --- 4. ГЛОБАЛЬНЫЕ НАСТРОЙКИ ТЕНЕЙ В ДВИЖКЕ (EEVEE) ---
scene = bpy.context.scene
scene.eevee.shadow_cube_size = str(shadow_resolution)
scene.eevee.shadow_cascade_size = str(shadow_resolution)
scene.eevee.use_soft_shadows = True # Включает алгоритм мягких теней

# --- 5. ПОЗИЦИОНИРОВАНИЕ ---
if scene.camera:
    cam = scene.camera
    target_obj = bpy.data.objects.new("Sun_Target", None)
    bpy.context.collection.objects.link(target_obj)
    target_obj.location = (0, 0, 0) # Фокус на центр сцены
    
    # Ставим солнце за плечо камеры
    sun_obj.location = cam.location + mathutils.Vector((15, 15, 20))
    
    track = sun_obj.constraints.new(type='TRACK_TO')
    track.target = target_obj
    track.track_axis = 'TRACK_NEGATIVE_Z'
    track.up_axis = 'UP_Y'

print(f"Солнце настроено: Разрешение {shadow_resolution}, Мягкость {sun_softness}")
